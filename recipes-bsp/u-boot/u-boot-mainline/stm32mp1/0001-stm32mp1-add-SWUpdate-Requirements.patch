From 618ee864fc0956ff7046fab22d43f7bf55a1a068 Mon Sep 17 00:00:00 2001
From: Joris Offouga <offougajoris@gmail.com>
Date: Thu, 29 Aug 2019 18:11:38 +0200
Subject: [PATCH] stm32mp1: add SWUpdate Requirements

Signed-off-by: Joris Offouga <offougajoris@gmail.com>
---
 configs/stm32mp15_basic_defconfig |  2 ++
 include/configs/stm32mp1.h        | 25 +++++++++++++++++++++++++
 2 files changed, 27 insertions(+)

diff --git a/configs/stm32mp15_basic_defconfig b/configs/stm32mp15_basic_defconfig
index 6d08c92493..80bf53ab40 100644
--- a/configs/stm32mp15_basic_defconfig
+++ b/configs/stm32mp15_basic_defconfig
@@ -11,6 +11,7 @@ CONFIG_SPL_TEXT_BASE=0x2FFC2500
 CONFIG_DISTRO_DEFAULTS=y
 CONFIG_FIT=y
 CONFIG_BOOTCOMMAND="run bootcmd_stm32mp"
+CONFIG_PREBOOT="if env exists swu_setup; then echo 'Use default'; else env save; env save;fi"
 CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_USE_PARTITION=y
 CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_PARTITION=3
 CONFIG_SPL_I2C_SUPPORT=y
@@ -57,6 +58,7 @@ CONFIG_ENV_IS_IN_UBI=y
 CONFIG_ENV_UBI_PART="UBI"
 CONFIG_ENV_UBI_VOLUME="uboot_config"
 CONFIG_ENV_UBI_VOLUME_REDUND="uboot_config_r"
+CONFIG_BOOTCOUNT_ENV=y
 CONFIG_USB_FUNCTION_FASTBOOT=y
 CONFIG_FASTBOOT_BUF_ADDR=0xC0000000
 CONFIG_FASTBOOT_BUF_SIZE=0x02000000
diff --git a/include/configs/stm32mp1.h b/include/configs/stm32mp1.h
index 69ba4e2fb6..c2cce31477 100644
--- a/include/configs/stm32mp1.h
+++ b/include/configs/stm32mp1.h
@@ -142,6 +142,30 @@
 #define STM32MP_MTDPARTS
 #endif

+#define SWUPDATE_ENV_SETTINGS \
+	"bootlimit=1\0"	\
+	"bootcount=0\0"	\
+	"upgrade_available=0\0"	\
+	"rootpart=5\0" \
+	\
+	"swu_setup="                                                     \
+	"setenv expand_bootargs \"setenv bootargs \\\\\"${bootargs}\\\\\"\"; "              \
+	"run expand_bootargs; "                                             \
+	"setenv expand_bootargs;\0"                                          \
+	\
+	"swu_altbootcmd="	\
+	"if test ${rootpart} = 5; then " \
+	"echo Bountcount limit reached. Reverting to B; " \
+	"setenv rootpart 6; "	\
+	"else "	\
+	"echo Bountcount limit reached. Reverting to A; " \
+	"setenv rootpart 5; "	\
+	"fi; " \
+	"setenv upgrade_available 0; " \
+	"saveenv\0" \
+	\
+	"altbootcmd=run swu_altbootcmd; " \
+	"run bootcmd_mmc0\0"
 /*
  * memory layout for 32M uncompressed/compressed kernel,
  * 1M fdt, 1M script, 1M pxe and 1M for splashimage
@@ -164,6 +188,7 @@
	STM32MP_BOOTCMD \
	STM32MP_MTDPARTS \
	BOOTENV \
+	SWUPDATE_ENV_SETTINGS \
	"boot_net_usb_start=true\0"

 #endif /* ifndef CONFIG_SPL_BUILD */
--
2.17.1

