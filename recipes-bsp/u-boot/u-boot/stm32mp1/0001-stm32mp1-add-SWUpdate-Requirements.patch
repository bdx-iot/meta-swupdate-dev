From 6c7941273dd6ca21d818ba7ae5262195dff58c62 Mon Sep 17 00:00:00 2001
From: Joris Offouga <offougajoris@gmail.com>
Date: Thu, 19 Jan 2023 21:16:05 +0000
Subject: [PATCH] stm32mp1: add SWUpdate Requirements

Signed-off-by: Joris Offouga <offougajoris@gmail.com>
---
 configs/stm32mp15_basic_defconfig  |  2 ++
 include/configs/stm32mp15_common.h | 28 +++++++++++++++++++++++++++-
 2 files changed, 29 insertions(+), 1 deletion(-)

diff --git a/configs/stm32mp15_basic_defconfig b/configs/stm32mp15_basic_defconfig
index 2cc26d4066..7211353f4b 100644
--- a/configs/stm32mp15_basic_defconfig
+++ b/configs/stm32mp15_basic_defconfig
@@ -23,6 +23,7 @@ CONFIG_SYS_LOAD_ADDR=0xc2000000
 CONFIG_FIT=y
 CONFIG_BOOTDELAY=1
 CONFIG_BOOTCOMMAND="run bootcmd_stm32mp"
+CONFIG_PREBOOT="if env exists swu_setup; then echo 'Use default'; else env save; env save;fi"
 CONFIG_SPL_LOG=y
 CONFIG_BOARD_EARLY_INIT_F=y
 CONFIG_SYS_MMCSD_RAW_MODE_U_BOOT_USE_PARTITION=y
@@ -80,6 +81,7 @@ CONFIG_SYS_MMC_ENV_DEV=-1
 # CONFIG_SPL_ENV_IS_NOWHERE is not set
 # CONFIG_SPL_ENV_IS_IN_SPI_FLASH is not set
 CONFIG_STM32_ADC=y
+CONFIG_BOOTCOUNT_ENV=y
 CONFIG_SET_DFU_ALT_INFO=y
 CONFIG_USB_FUNCTION_FASTBOOT=y
 CONFIG_FASTBOOT_BUF_ADDR=0xC0000000
diff --git a/include/configs/stm32mp15_common.h b/include/configs/stm32mp15_common.h
index dab679f71e..50bb7ef2d9 100644
--- a/include/configs/stm32mp15_common.h
+++ b/include/configs/stm32mp15_common.h
@@ -168,13 +168,39 @@
 	"fdtoverlay_addr_r=" __FDTOVERLAY_ADDR_R "\0" \
 	"ramdisk_addr_r=" __RAMDISK_ADDR_R "\0"
 
+#define SWUPDATE_ENV_SETTINGS \
+	"bootlimit=1\0"	\
+	"bootcount=0\0"	\
+	"upgrade_available=0\0"	\
+	"rootpart=5\0" \
+	\
+	"swu_setup="                                                     \
+	"setenv expand_bootargs \"setenv bootargs \\\\\"${bootargs}\\\\\"\"; "              \
+	"run expand_bootargs; "                                             \
+	"setenv expand_bootargs;\0"                                          \
+	\
+	"swu_altbootcmd="	\
+	"if test ${rootpart} = 5; then " \
+	"echo Bountcount limit reached. Reverting to B; " \
+	"setenv rootpart 6; "	\
+	"else "	\
+	"echo Bountcount limit reached. Reverting to A; " \
+	"setenv rootpart 5; "	\
+	"fi; " \
+	"setenv upgrade_available 0; " \
+	"saveenv\0" \
+	\
+	"altbootcmd=run swu_altbootcmd; " \
+	"run bootcmd_mmc0\0"
+
 #define CONFIG_EXTRA_ENV_SETTINGS \
 	STM32MP_MEM_LAYOUT \
 	STM32MP_BOOTCMD \
 	STM32MP_PARTS_DEFAULT \
 	BOOTENV \
 	STM32MP_EXTRA \
-	STM32MP_BOARD_EXTRA_ENV
+	STM32MP_BOARD_EXTRA_ENV \
+	SWUPDATE_ENV_SETTINGS
 
 #endif /* ifndef CONFIG_SPL_BUILD */
 #endif /* ifdef CONFIG_DISTRO_DEFAULTS*/
-- 
2.34.1

